# playbooks/bootstrap.yml
- name: Base bootstrap for EC2 via SSM (Kubernetes-friendly)
  hosts: all
  become: true
  gather_facts: true

  tasks:
    # --- APT prereqs & Kubernetes repository/keyring ---

    - name: Ensure base dependencies present
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes
      tags: [bootstrap, "bootstrap:apt"]

    - name: Ensure keyring directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      tags: [bootstrap, "bootstrap:apt"]

    - name: Download Kubernetes Release.key
      ansible.builtin.get_url:
        url: https://pkgs.k8s.io/core:/stable:/v1.32/deb/Release.key
        dest: /etc/apt/keyrings/kubernetes-release.key
        mode: '0644'
      tags: [bootstrap, "bootstrap:apt"]

    - name: Convert Release.key to GPG keyring (one-time)
      ansible.builtin.command:
        argv:
          - gpg
          - --dearmor
          - -o
          - /etc/apt/keyrings/kubernetes-apt-keyring.gpg
          - /etc/apt/keyrings/kubernetes-release.key
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      notify: Update apt cache
      tags: [bootstrap, "bootstrap:apt"]

    - name: Add Kubernetes apt repository
      ansible.builtin.apt_repository:
        repo: 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /'
        filename: kubernetes
        state: present
      notify: Update apt cache
      tags: [bootstrap, "bootstrap:apt"]

    - name: Install Kubernetes packages (example pin)
      ansible.builtin.apt:
        name:
          - kubelet=1.32.*-1.1
          - kubeadm=1.32.*-1.1
          - kubectl=1.32.*-1.1
        state: present
      tags: [bootstrap, "bootstrap:k8s"]

    # --- Swap disabled (runtime + persistent) ---

    - name: Disable any active swap now
      ansible.posix.mount:
        name: none
        fstype: swap
        state: absent
      tags: [bootstrap, "bootstrap:swap"]

    - name: Remove swap from fstab (persist across reboots)
      ansible.posix.mount:
        path: none
        fstype: swap
        state: absent
      tags: [bootstrap, "bootstrap:swap"]

    # --- Kernel modules for Kubernetes ---

    - name: Write kernel modules config for Kubernetes networking
      ansible.builtin.copy:
        dest: /etc/modules-load.d/k8s.conf
        mode: '0644'
        content: |
          overlay
          br_netfilter
      tags: [bootstrap, "bootstrap:kernelmods"]

    - name: Load overlay module now
      ansible.builtin.command: modprobe overlay
      changed_when: false
      failed_when: false
      tags: [bootstrap, "bootstrap:kernelmods"]

    - name: Load br_netfilter module now
      ansible.builtin.command: modprobe br_netfilter
      changed_when: false
      failed_when: false
      tags: [bootstrap, "bootstrap:kernelmods"]

    # --- Sysctls (persistent + applied immediately) ---

    - name: Ensure Kubernetes sysctls are set (persistent + runtime)
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
        sysctl_file: /etc/sysctl.d/99-k8s.conf
      loop:
        - { name: 'net.bridge.bridge-nf-call-iptables',  value: '1' }
        - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { name: 'net.ipv4.ip_forward',                 value: '1' }
      tags: [bootstrap, "bootstrap:sysctl"]

    # --- Journald persistence for log survival across reboots ---

    - name: Ensure journald is persistent
      ansible.builtin.lineinfile:
        path: /etc/systemd/journald.conf
        regexp: '^#?Storage='
        line: 'Storage=persistent'
      notify: Restart journald
      tags: [bootstrap, "bootstrap:logs"]  
        # --- Containerd + Kubelet prep -----------------------------------------
    - name: Ensure containerd installed
      ansible.builtin.apt:
        name:
          - containerd
        state: present
        update_cache: yes
      tags: [bootstrap, "bootstrap:containerd"]

    - name: Ensure containerd config directory exists
      ansible.builtin.file:
        path: /etc/containerd
        state: directory
        mode: '0755'
      tags: [bootstrap, "bootstrap:containerd"]

    - name: Generate default containerd config if missing
      ansible.builtin.command:
        argv: [containerd, config, default]
      register: _containerd_default
      changed_when: _containerd_default.rc == 0
      args:
        creates: /etc/containerd/config.toml
      tags: [bootstrap, "bootstrap:containerd"]

    - name: Write containerd config with SystemdCgroup=true
      ansible.builtin.copy:
        dest: /etc/containerd/config.toml
        mode: '0644'
        content: >
          {{ _containerd_default.stdout if _containerd_default.stdout is defined
          else lookup('ansible.builtin.file', '/etc/containerd/config.toml') }}
      when: _containerd_default is defined
      notify: Restart containerd
      tags: [bootstrap, "bootstrap:containerd"]

    - name: Ensure SystemdCgroup=true in config.toml (idempotent edit)
      ansible.builtin.replace:
        path: /etc/containerd/config.toml
        regexp: '^(\s*SystemdCgroup\s*=\s*)false'
        replace: '\1true'
      notify: Restart containerd
      tags: [bootstrap, "bootstrap:containerd"]

    - name: Ensure containerd service enabled and running
      ansible.builtin.systemd:
        name: containerd
        enabled: true
        state: started
      tags: [bootstrap, "bootstrap:containerd"]

    # Kubelet runtime endpoint (safe even before kubelet install)
    - name: Ensure kubelet drop-in directory exists
      ansible.builtin.file:
        path: /etc/systemd/system/kubelet.service.d
        state: directory
        mode: '0755'
      tags: [bootstrap, "bootstrap:kubelet"]

    - name: Configure kubelet to use containerd
      ansible.builtin.copy:
        dest: /etc/systemd/system/kubelet.service.d/10-containerd.conf
        mode: '0644'
        content: |
          [Service]
          Environment="KUBELET_EXTRA_ARGS=--container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock"
      notify: Reload systemd and restart kubelet
      tags: [bootstrap, "bootstrap:kubelet"]

    - name: Hold Kubernetes packages at current major.minor
      ansible.builtin.command:
        argv: [apt-mark, hold, kubelet, kubeadm, kubectl]
      register: _hold
      changed_when: "'kubelet set on hold' in _hold.stdout or 'kubeadm set on hold' in _hold.stdout or 'kubectl set on hold' in _hold.stdout"
      failed_when: false
      tags: [bootstrap, "bootstrap:k8s"]


  handlers:
  
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes

    - name: Sysctl reload
      ansible.builtin.command:
        argv: [sysctl, --system]

    - name: Restart journald
      ansible.builtin.systemd:
        name: systemd-journald
        state: restarted

    - name: Restart containerd
      ansible.builtin.systemd:
        name: containerd
        state: restarted
        daemon_reload: yes

    - name: Reload systemd and restart kubelet
      ansible.builtin.systemd:
        name: kubelet
        state: restarted
        daemon_reload: yes
