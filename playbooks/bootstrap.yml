# playbooks/bootstrap.yml
- name: Base bootstrap for EC2 via SSM (Kubernetes-friendly)
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Disable any active swap now
      ansible.posix.mount:
        name: none
        fstype: swap
        state: absent
      tags: [bootstrap, "bootstrap:swap"]

    - name: Remove swap from fstab (persist across reboots)
      ansible.posix.mount:
        path: none
        fstype: swap
        state: absent
      tags: [bootstrap, "bootstrap:swap"]

    - name: Write kernel modules config for Kubernetes networking
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter
        owner: root
        group: root
        mode: '0644'
      notify: Load k8s kernel modules
      tags: [bootstrap, "bootstrap:kernelmods"]

    - name: Write sysctl file for Kubernetes networking
      copy:
        dest: /etc/sysctl.d/99-k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1
        owner: root
        group: root
        mode: '0644'
      notify: Sysctl reload
      tags: [bootstrap, "bootstrap:sysctl"]

    - name: Ensure journald is persistent
      lineinfile:
        path: /etc/systemd/journald.conf
        regexp: '^#?Storage='
        line: 'Storage=persistent'
      notify: Restart journald
      tags: [bootstrap, "bootstrap:logs"]

  handlers:
    - name: Load k8s kernel modules
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: Sysctl reload
      command: sysctl -p /etc/sysctl.d/99-k8s.conf

    - name: Restart journald
      systemd:
        name: systemd-journald
        state: restarted
