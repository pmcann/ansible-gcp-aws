# playbooks/bootstrap.yml
- name: Base bootstrap for EC2 via SSM (Kubernetes-friendly)
  hosts: all
  become: true
  gather_facts: true

  vars:
    k8s_repo_url: "https://pkgs.k8s.io/core:/stable:/v1.32/deb/"
    k8s_key_path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    k8s_release_key: /etc/apt/keyrings/kubernetes-release.key
    k8s_packages:
      - kubelet=1.32.*-1.1
      - kubeadm=1.32.*-1.1
      - kubectl=1.32.*-1.1
    sysctls:
      - { name: "net.bridge.bridge-nf-call-iptables", value: "1" }
      - { name: "net.bridge.bridge-nf-call-ip6tables", value: "1" }
      - { name: "net.ipv4.ip_forward", value: "1" }

  tasks:
    # ---------- APT prereqs + Kubernetes repo ----------
    - name: Ensure base dependencies present
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes
      tags: [bootstrap, "bootstrap:apt"]

    - name: Ensure keyring directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      tags: [bootstrap, "bootstrap:apt"]

    - name: Download Kubernetes Release.key
      ansible.builtin.get_url:
        url: "{{ k8s_repo_url }}Release.key"
        dest: "{{ k8s_release_key }}"
        mode: '0644'
      tags: [bootstrap, "bootstrap:apt"]

    - name: Convert Release.key to GPG keyring (one-time)
      ansible.builtin.command:
        argv:
          - gpg
          - --dearmor
          - -o
          - "{{ k8s_key_path }}"
          - "{{ k8s_release_key }}"
      args:
        creates: "{{ k8s_key_path }}"
      notify: Update apt cache
      tags: [bootstrap, "bootstrap:apt"]

    - name: Add Kubernetes apt repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by={{ k8s_key_path }}] {{ k8s_repo_url }} /"
        filename: kubernetes
        state: present
      notify: Update apt cache
      tags: [bootstrap, "bootstrap:apt"]

    - name: Install Kubernetes packages (pinned)
      ansible.builtin.apt:
        name: "{{ k8s_packages }}"
        state: present
      tags: [bootstrap, "bootstrap:k8s"]

    # ---------- Swap off + persist ----------
    - name: Disable any active swap now
      ansible.builtin.command: swapoff -a
      changed_when: false
      failed_when: false
      tags: [bootstrap, "bootstrap:kernel"]

    - name: Remove swap from fstab (persist across reboots)
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^\s*([^#\s]+\s+){2}swap\s+'
        replace: '# \g<0>'
      tags: [bootstrap, "bootstrap:kernel"]

    # ---------- Kernel modules + sysctls ----------
    - name: Write kernel modules config for Kubernetes networking
      ansible.builtin.copy:
        dest: /etc/modules-load.d/k8s.conf
        mode: '0644'
        content: |
          overlay
          br_netfilter
      tags: [bootstrap, "bootstrap:kernel"]

    - name: Load overlay module now
      ansible.builtin.modprobe:
        name: overlay
        state: present
      tags: [bootstrap, "bootstrap:kernel"]

    - name: Load br_netfilter module now
      ansible.builtin.modprobe:
        name: br_netfilter
        state: present
      tags: [bootstrap, "bootstrap:kernel"]

    - name: Ensure Kubernetes sysctls are set (persistent + runtime)
      ansible.builtin.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-k8s.conf
        reload: yes
      loop: "{{ sysctls }}"
      tags: [bootstrap, "bootstrap:kernel"]

    # ---------- journald persistence ----------
    - name: Ensure journald is persistent
      ansible.builtin.lineinfile:
        path: /etc/systemd/journald.conf
        regexp: '^#?\s*Storage='
        line: 'Storage=persistent'
        create: yes
        mode: '0644'
      notify: Restart journald
      tags: [bootstrap, "bootstrap:os"]

    # ---------- containerd runtime ----------
    - name: Ensure containerd installed
      ansible.builtin.apt:
        name: containerd
        state: present
      tags: [bootstrap, "bootstrap:containerd"]

    - name: Ensure containerd config directory exists
      ansible.builtin.file:
        path: /etc/containerd
        state: directory
        mode: '0755'
      tags: [bootstrap, "bootstrap:containerd"]

    - name: Write containerd config (v2, SystemdCgroup=true)
      ansible.builtin.copy:
        dest: /etc/containerd/config.toml
        mode: '0644'
        content: |
          version = 2

          [plugins."io.containerd.grpc.v1.cri"]
            sandbox_image = "registry.k8s.io/pause:3.9"

          [plugins."io.containerd.grpc.v1.cri".containerd]
            default_runtime_name = "runc"

          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
            runtime_type = "io.containerd.runc.v2"

          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
            SystemdCgroup = true
      notify: Restart containerd
      tags: [bootstrap, "bootstrap:containerd"]

    - name: Validate containerd config (syntax check)
      ansible.builtin.command:
        argv: [containerd, config, dump]
      register: containerd_cfg_check
      changed_when: false
      failed_when: containerd_cfg_check.rc != 0
      tags: [bootstrap, "bootstrap:containerd"]

    - name: Ensure containerd service enabled and running
      ansible.builtin.systemd:
        name: containerd
        state: started
        enabled: true
      tags: [bootstrap, "bootstrap:containerd"]

    # ---------- kubelet -> containerd wiring ----------
    - name: Ensure kubelet drop-in directory exists
      ansible.builtin.file:
        path: /etc/systemd/system/kubelet.service.d
        state: directory
        mode: '0755'
      tags: [bootstrap, "bootstrap:k8s"]

    - name: Configure kubelet to use containerd
      ansible.builtin.copy:
        dest: /etc/systemd/system/kubelet.service.d/10-containerd.conf
        mode: '0644'
        content: |
          [Service]
          Environment="KUBELET_KUBEADM_ARGS=--container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock"
      notify: Restart kubelet
      tags: [bootstrap, "bootstrap:k8s"]

    - name: Hold Kubernetes packages at current major.minor
      ansible.builtin.command:
        argv: ["apt-mark", "hold", "kubelet", "kubeadm", "kubectl"]
      register: hold_out
      changed_when: "'held back' in hold_out.stdout or 'set on hold' in hold_out.stdout"
      failed_when: false
      tags: [bootstrap, "bootstrap:k8s"]

  handlers:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes

    - name: Restart journald
      ansible.builtin.systemd:
        name: systemd-journald
        state: restarted

    - name: Restart containerd
      ansible.builtin.systemd:
        name: containerd
        state: restarted
        enabled: true

    - name: Restart kubelet
      ansible.builtin.systemd:
        name: kubelet
        state: restarted
        enabled: true

