# playbooks/bootstrap.yml
- name: Base bootstrap for EC2 via SSM (Kubernetes-friendly)
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Disable any active swap now
      ansible.posix.mount:
        name: none
        fstype: swap
        state: absent
      tags: [bootstrap, "bootstrap:swap"]

    - name: Remove swap from fstab (persist across reboots)
      ansible.posix.mount:
        path: none
        fstype: swap
        state: absent
      tags: [bootstrap, "bootstrap:swap"]

    - name: Write kernel modules config for Kubernetes networking
      copy:
        dest: /etc/modules-load.d/k8s.conf
        mode: "0644"
        content: |
          overlay
          br_netfilter
      notify: Load k8s kernel modules
      tags: [bootstrap, "bootstrap:kernelmods"]

    - name: Ensure sysctl settings for Kubernetes networking
      copy:
        dest: /etc/sysctl.d/k8s.conf
        mode: "0644"
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1
      notify: Sysctl reload
      tags: [bootstrap, "bootstrap:sysctl"]

    - name: Make journald logs persistent across reboots
      lineinfile:
        path: /etc/systemd/journald.conf
        regexp: '^#?Storage='
        line: 'Storage=persistent'
        create: no
      notify: Restart journald
      tags: [bootstrap, "bootstrap:journald"]

  handlers:
    - name: Load k8s kernel modules
      # Using commands avoids needing extra Galaxy collections.
      # Marked no-change to keep the play idempotent.
      block:
        - name: modprobe overlay
          command: modprobe overlay
          changed_when: false
        - name: modprobe br_netfilter
          command: modprobe br_netfilter
          changed_when: false

    - name: Sysctl reload
      command: sysctl --system
      changed_when: false

    - name: Restart journald
      systemd:
        name: systemd-journald
        state: restarted
      changed_when: false

