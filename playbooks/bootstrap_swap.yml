---
- name: Disable swap without shell
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Disable any active swap now
      ansible.builtin.mount:
        path: none
        fstype: swap
        state: unmounted

    - name: Remove swap from fstab (persist across reboots)
      ansible.builtin.mount:
        path: none
        fstype: swap
        state: absent

    - name: Re-gather minimal facts for swap check
      ansible.builtin.setup:
        filter: ansible_swap*
        gather_subset:
          - hardware

    - name: Assert swap is disabled
      ansible.builtin.assert:
        that:
          - ansible_facts.swaptotal_mb | int == 0
        fail_msg: "Swap is still configured"
        success_msg: "Swap disabled"
